name: Run build
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  schedule:
    - cron: "0 7 * * 1,3,5"
env:
  VBUILD_UNIT_TESTS: true
  CONAN_VER: 1.57.0
jobs:

  run-build-ubuntu:
    runs-on: ubuntu-20.04
    timeout-minutes: 75
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."

      - name: Install valgrind and code coverage
        run: |
          sudo apt-get -y install lcov html2text

      # - name: Install valgrind and code coverage
      #   run: |
      #     sudo apt-get -y install valgrind=1:3.15.0-1ubuntu9.1 lcov html2text

      - name: Install Conan
        run: pip3 install conan==${{ env.CONAN_VER }} --force

      - name: Git clone opentdf 
        run: |
          git clone --depth 1 https://github.com/opentdf/opentdf.git
      
      # - uses: yokawasa/action-setup-kube-tools@v0.9.2
      #   with:
      #     setup-tools: |
      #       kubectl
      #       helm
      #       tilt
      #     # This should be in sync with the minikube-deployed kube version below
      #     kubectl: "1.24.1"
      #     helm: "3.9.1"
      #     tilt: "0.30.4"
      # - run: |
      #     kubectl version --client
      #     kustomize version
      #     tilt version
      # - name: start minikube
      #   id: minikube
      #   uses: medyagh/setup-minikube@master
      #   with:
      #     minikube-version: 1.26.0
      #     # This should be in sync with the setup-tools version above
      #     kubernetes-version: 1.24.1

      - name: Run tilt & C++ build and run sanity test
        env:
          # This test script is passed to opentdf/quickstart tilt file
          TEST_SCRIPT: ../../build-and-run-sanity-test.sh
        run: |-
          pwd
          ls
          cd src && ./build-all.sh
          echo "pwd"
          pwd
      # - name: Generate a code coverage report
      #   uses: threeal/gcovr-action@latest
      #   with:
      #     exclude: |
      #       src/lib/src/tdf_client_c.cpp
      #       src/lib/src/tdf_html_writer.h
      #       src/lib/src/tdf_html_writer.cpp

      - name: Get Version
        run: |
          VER=$(cat VERSION)
          echo "V_VERSION=$VER" >> $GITHUB_ENV

      - name: Get Timestamp
        run : |
          TSTAMP=$(date +'%Y%m%d%H%M%S')
          echo "V_TIMESTAMP=$TSTAMP" >> $GITHUB_ENV

      - name: Save artifacts
        uses: actions/upload-artifact@v3
        if: (github.event_name != 'pull_request') && (github.event_name != 'schedule')
        with:
          name: opentdf-client-cpp-lin-${{ env.V_VERSION }}-${{ env.V_TIMESTAMP }}
          path: |
            dist/*

      - name: Save artifacts
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage
          path: |
            code-coverage.tar.gz
            
      - run: echo "üçè This job's status is ${{ job.status }}."
      
  ci:
    needs:
      - run-build-ubuntu
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: exit 1
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
